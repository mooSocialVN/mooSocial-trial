(function(l,B){"function"===typeof define&&define.amd?define(["jquery","overlay","textcomplete","bloodhound"],B):"object"===typeof exports?module.exports=B(require("jquery")):l.mooMention=B()})(this,function(l){function B(a,f){var d=String(a.data.obj.value),e=l(a.data.mirrorCheckSpell).html();e=jQuery("<div />").html(e).text();if(d!=e){a:{var b=e;var g=d.split(/(\s+)/);b=b.split(/(\s+)/);for(var h=index=0;h<g.length;h++){if(g[h]!=b[h]){g={beforeChanged:b[h],afterChanged:g[h],index:index};break a}index+=
b[h].length}g=void 0}d.split("");e.split("");e=g.beforeChanged;b=g.afterChanged;if(void 0!=e&&void 0!=b){if(e.length<b.length&&(rangeSpell=b.length-e.length,0<Object.keys(c).length))for(var k in c)c.hasOwnProperty(k)&&c[k].start>g.index&&(c[k].start+=rangeSpell,c[k].end+=rangeSpell);if(e.length>b.length&&(rangeSpell=e.length-b.length,0<Object.keys(c).length))for(k in c)c.hasOwnProperty(k)&&c[k].start>g.index&&(c[k].start-=rangeSpell,c[k].end-=rangeSpell)}l(a.data.mirrorCheckSpell).html(d);k=a.data.mirror;
e=[];d=d.split("");g="";if(0<Object.keys(c).length){b=0;for(m in c)c.hasOwnProperty(m)&&(e[b]=c[m],e[b].key=m,b++);for(b=0;b<e.length-1;b++)for(j=b+1;j<e.length;j++)if(e[b].start>e[j].start){var m=e[j];e[j]=e[b];e[b]=m}}for(b=0;b<d.length;b++){m=!1;if(0<e.length)for(j=0;j<e.length;j++)b==e[j].start&&(g+="@["+e[j].key+":"+d[b],m=!0),b==e[j].end&&(g+="]"+d[b],m=!0);m||(g+=d[b])}for(j=0;j<e.length;j++)e[j].end==d.length&&(g+="]");k.value=g;v(l(a.data.obj))}}var G,H,C={},w=[],y,N,I,c={},z={},O={},P=!1,
A=[];if(mooConfig.isMention)l("body").on("focus","textarea",function(){var a=l(this).siblings("input.messageHidden");0<a.length&&(E(l(this)),Q(a.val(),l(this)))});l("body").on("keydown",function(a){a.stopPropagation();if(116==a.which){var f=l("textarea");l.each(f,function(d,e){if(""!=l(e).val())return a.preventDefault(),window.confirm("This page is asking you to confirm that you want to leave - data you have entered may not be saved.")&&(l("textarea").val(""),l(".messageHidden").val(""),window.location.reload()),
!1})}});var K=function(a,f){l("#"+f).destroyOverlayInstance(l("#"+f));l("#"+f).textcomplete([{mentions:a,match:/\B@(\w*)$/,search:function(d,e){console.log(d);N=d.length;e(l.map(this.mentions,function(b,g){if(-1!=w.indexOf(g))return null;a:{var h=d.toLowerCase();var k="\\()[]^{}*+?$.".split(""),m;for(m in k)if(k.hasOwnProperty(m)&&-1!=h.indexOf(k[m])){h=!0;break a}h=!1}if(h)return null;h=new RegExp("\\b"+d.toLowerCase(),"g");if(b)return b.toLowerCase().match(h)?g:null}))},template:function(d){return'<img src="'+
O[d]+'" class="user_avatar_small" /> '+C[d]},index:1,replace:function(d){return C[d]}}],{appendTo:"body",zIndex:1055}).overlay([{match:{},css:{"background-color":"#CAD8F4"}}]).on({"textComplete:select":function(d,e,b){d=C[e];for(var g in C)if(e==g){b=l(this).prop("selectionStart")-d.length+1;var h=void 0,k=b,m=void 0,p={};if(0<Object.keys(c).length)for(h in c)c.hasOwnProperty(h)&&k>=c[h].end&&(k+=replaceLength[h].length-c[h].length,m+=replaceLength[h].length-c[h].length);p.start=k;p.end=m;var q=p;
h=void 0;p=g;k=d;m=l(this);q=q.start;var t=N,r=document.createElement("textarea");r.innerHTML=k;k=r.value;r=m.siblings(".messageHidden");var D=r.val(),x="["+p+":"+k+"]",n=D.substring(0,q),J=D.substring(q);J=J.replace(D.substring(q,q+t),x);r.val(n+J);m.siblings(".checkSpell").html(m.val());replaceLength[p]={start:q-1,end:q+x.length,length:x.length+1};p=x.length+1;if(0<Object.keys(c).length)for(h in c)c.hasOwnProperty(h)&&q-1<=c[h].start&&(replaceLength[h].start=replaceLength[h].start-(t+1)+p,replaceLength[h].end=
replaceLength[h].end-(t+1)+p,c[h].start=c[h].start-(t+1)+k.length,c[h].end=c[h].end-(t+1)+k.length);v(m);w.push(g);--b;c[g]={start:b,end:l(this).prop("selectionStart"),length:l(this).prop("selectionStart")-b};v(l(this),!0)}}});0==l("#"+f).siblings("input.messageHidden").length&&("edit_activity"==I?l("#"+f).after('<input type="hidden" id="'+f+'_hidden" name="data[message]" class="messageHidden" /><div class="checkSpell" style="display: none"></div>'):l("#"+f).after('<input type="hidden" name="data[message]" class="messageHidden" /><div class="checkSpell" style="display: none"></div>'));
y=l("#"+f).siblings(".messageHidden")[0];mirrorCheckSpell=jQuery("#"+f).siblings(".checkSpell")[0];"edit_activity"==I&&(y.value=H);l("#"+f).on("keypress keydown",{obj:jQuery("#"+f)[0],mirror:y,mirrorCheckSpell:mirrorCheckSpell},R);l("#"+f).bind("input",{obj:jQuery("#"+f)[0],mirror:y,mirrorCheckSpell:mirrorCheckSpell},B);l("#"+f).on("paste",{obj:jQuery("#"+f)[0],mirror:y,mirrorCheckSpell:mirrorCheckSpell},X);l("#"+f).on("cut",{obj:jQuery("#"+f)[0],mirror:y,mirrorCheckSpell:mirrorCheckSpell},Y)},Q=
function(a,f){var d=0,e=0;E(f);var b=a.replace(/@\[(\d+):([^\]]+)\]/g,function(g,h,k){w.push(h);replaceLength[h]={start:a.indexOf(g),end:a.indexOf(g)+g.length,length:g.length};var m=a.indexOf(g)-d+e;c[h]={start:m,end:m+k.length,length:k.length};d+=g.length;e+=k.length;return k});f.val(b);v(f)},R=function(a,f){if(Z(a)||"undefined"!=typeof f){var d=l(a.data.obj).prop("selectionStart"),e=d,b=l(a.data.obj).prop("selectionEnd"),g=b,h=String(a.data.mirror.value),k=String(a.data.obj.value),m=!1,p=0;if("keypress"!=
a.type||!a.metaKey||99!=a.which){if(0<Object.keys(c).length){var q=!1;for(n in c){if(q&&!m)break;if(c.hasOwnProperty(n)){if(e>=c[n].end)d=u(e),b=u(e,g),e==c[n].end&&"keydown"==a.type&&8==a.which&&e==g&&(a.preventDefault(),e=S(e-1,k,n),p=g-e,F(a,k,e,g),b=T(n,d,b,e,g),d=b.selectionStart,b=b.selectionEnd,q=!0);else{if(g>c[n].start&&e<c[n].start||g>c[n].end&&e<c[n].end){b=String(a.data.obj.value);d=u(e);h=U(d,b,h,e);d=b.substring(g);m=13==a.which?"\\n":32==a.which?" ":"keydown"!=a.type||46!=a.which&&
8!=a.which?"undefined"==typeof f||"cut"!=a.type&&"delete"!=a.type?String.fromCharCode(a.which):"":"";a.data.mirror.value=h+m+d;L(n,e);jQuery(a.data.mirrorCheckSpell).html(k.substring(0,e)+m+k.substring(g));v(l(a.data.obj));return}if(e==c[n].start||e==c[n].start&&g==c[n].end){if(e!=g||e==g&&"keydown"==a.type&&46==a.which)a.preventDefault(),q=0,e!=g&&8==a.which?q=1:46==a.which&&(q=1),u(e),u(e,g),g=V(e,k,n),b=g<c[n].end?1:0,g==c[n].end&&a.preventDefault(),q=g<c[n].end?q:0,p=g-e,d=replaceLength[n].end-
c[n].length-1,b=d+p+b,g+=q,F(a,k,e,g),W(d,b,n),q=!0}else if(c[n].start<e&&c[n].end>e){if("keydown"==a.type&&46==a.which||8==a.which)a.preventDefault(),d=u(e),b=u(e,g),e==g&&(8==a.which&&e>c[n].start?(g--,e--):46==a.which&&g<c[n].end&&(g++,e++),e>c[n].start&&e--),e=S(e,k,n),g=V(g,k,n),g+=g<c[n].end&&e==c[n].start?1:0,p=g-e,F(a,k,e,g),b=T(n,d,b,e,g),d=b.selectionStart,b=b.selectionEnd;else{b=String(a.data.obj.value);h=h.substring(0,replaceLength[n].start);h+=b.substring(c[n].start,e);d=b.substring(g);
m=13==a.which?"\\n":32==a.which?" ":"keydown"==a.type&&46==a.which||8==a.which?"":"undefined"==typeof f||"cut"!=a.type&&"delete"!=a.type?String.fromCharCode(a.which):"";a.data.mirror.value=h+m+d;L(n,e);jQuery(a.data.mirrorCheckSpell).html(k.substring(0,e)+m+k.substring(g));v(l(a.data.obj));return}q=!0}}if(0==c[n].length){d=replaceLength[n].start;b=replaceLength[n].end+p;for(var t in w)w[t]==n&&w.splice(t,1);delete replaceLength[n];delete c[n];M(d,b,a,x);F(a,k,e,g);v(l(a.data.obj));var r=d;var D=b;
var x=p;m=!0;break}}}}m||("undefined"!=typeof r&&"undefined"!=typeof x?M(r,D,a,x):M(e,g,a));13==a.which?m="\n":32==a.which?m=" ":"keydown"!=a.type||46!=a.which&&8!=a.which?m="undefined"==typeof f||"cut"!=a.type&&"delete"!=a.type?"keypress"!=a.type||!a.metaKey||118!=a.which&&120!=a.which&&99!=a.which&&97!=a.which?String.fromCharCode(a.which):"":"":(m="",d==b&&(8==a.which?--d:46==a.which&&(b+=1)),e==g&&(8==a.which?--e:46==a.which&&(g+=1)));var n=h.substring(0,d);h=h.substring(b);a.data.mirror.value=
n+m+h;jQuery(a.data.mirrorCheckSpell).html(k.substring(0,e)+m+k.substring(g));v(l(a.data.obj))}}},X=function(a){var f=l(a.data.obj).prop("selectionStart"),d=f,e=l(a.data.obj).prop("selectionEnd"),b=e,g="",h,k=String(a.data.mirror.value),m=String(a.data.obj.value);setTimeout(function(){if("undefined"!=typeof a.data){var p=String(a.data.obj.value),q=l(a.data.obj).prop("selectionStart");l(a.data.obj).prop("selectionEnd");h=q-d-(b-d);g=p.substring(d,q);if(0<Object.keys(c).length)for(var t in c)if(c.hasOwnProperty(t))if(d==
b&&(d<=c[t].start||b>=c[t].end))f=u(d),e=u(d,b);else{f=u(d);var r=U(f,p,k,d);p=p.substring(q);a.data.mirror.value=r+g+p;L(t,d);jQuery(a.data.mirrorCheckSpell).html(m.substring(0,d)+g+m.substring(b));return}t=h;if(0<Object.keys(c).length)for(r in c)c.hasOwnProperty(r)&&d<=c[r].start&&(replaceLength[r].start+=t,replaceLength[r].end+=t,c[r].start+=t,c[r].end+=t);t=k.substring(0,f);p=k.substring(e,k.length);k=t+g+p;a.data.mirror.value=k;jQuery(a.data.mirrorCheckSpell).html(m.substring(0,d)+g+m.substring(b))}},
10)},Y=function(a){R(a,!0)},aa=function(a){var f=a.data.obj,d=a.data.mirror;setTimeout(function(){d.value=String(f.value);E(l(f))},10)},W=function(a,f,d){0<Object.keys(c).length&&(a=0==f-a?1:f-a,replaceLength[d].end-=a,replaceLength[d].length-=a,c[d].end-=a,c[d].length-=a)},Z=function(a){var f=a.which;if("keypress"==a.type&&8!=f)return 0!=f?a.ctrlKey?(!a.ctrlKey||90!=f&&89!=f||aa(a),!1):"none"!=l('ul[id^="textcomplete-dropdown"]').css("display")&&13==f?!1:!0:!1;if("keydown"==a.type){if(46==f||8==
f)return!0;if(116==f)0<Object.keys(c).length&&(a.preventDefault(),a.stopPropagation(),window.confirm("This page is asking you to confirm that you want to leave - data you have entered may not be saved.")&&(l("textarea").val(""),l(".messageHidden").val(""),window.location.reload()));else return!1}},M=function(a,f,d,e){if(0<Object.keys(c).length)for(var b in c)c.hasOwnProperty(b)&&(a<c[b].start&&(8!=d.which||0!=a||0!=f)?"keydown"==d.type&&(46==d.which||8==d.which)||"cut"==d.type?(replaceLength[b].start-=
f==a?1:f-a,replaceLength[b].end-=f==a?1:f-a,"undefined"==typeof e||0==e?(c[b].start-=f==a?1:f-a,c[b].end-=f==a?1:f-a):(c[b].start-=e,c[b].end-=e)):(replaceLength[b].start=replaceLength[b].start-(f-a)+1,replaceLength[b].end=replaceLength[b].end-(f-a)+1,"undefined"==typeof e||0==e?(c[b].start=c[b].start-(f-a)+1,c[b].end=c[b].end-(f-a)+1):(c[b].start=c[b].start-e+1,c[b].end=c[b].end-e+1)):a==c[b].start&&("keydown"!=d.type||46!=d.which&&8!=d.which)?(replaceLength[b].start=replaceLength[b].start-(f-a)+
1,replaceLength[b].end=replaceLength[b].end-(f-a)+1,"undefined"==typeof e||0==e?(c[b].start=c[b].start-(f-a)+1,c[b].end=c[b].end-(f-a)+1):(c[b].start=c[b].start-e+1,c[b].end=c[b].end-e+1)):a==c[b].start&&8==d.which&&0<replaceLength[b].start&&0<c[b].start&&a==f!=0&&(replaceLength[b].start--,replaceLength[b].end--,c[b].start--,c[b].end--))},L=function(a,f){for(var d in c)c.hasOwnProperty(d)&&"undefined"!=typeof f&&c[d].start<=f&&c[d].end>f&&(a=d);var e=c[a].start,b={},g={},h=[];for(d in c)c.hasOwnProperty(d)&&
c[d].start<e&&(b[d]=c[d],g[d]=replaceLength[d],h.push(d));c=b;replaceLength=g;w=h},u=function(a,f){var d=a,e=f,b;for(b in c)c.hasOwnProperty(b)&&c[b].end<=a&&("undefined"==typeof f?d+=replaceLength[b].length-c[b].length:e+=replaceLength[b].length-c[b].length);return"undefined"==typeof f?d:e},U=function(a,f,d,e){var b="",g;for(g in c)c.hasOwnProperty(g)&&a>replaceLength[g].start&&a<replaceLength[g].end&&(a=replaceLength[g].start,b=f.substring(c[g].start,e));return d.substring(0,a)+b},E=function(a){c=
{};replaceLength={};w=[];v(a)},v=function(a,f){G=a.getInstanceOverlay(a);a.revokeOverlay([{match:c}],G);a.reRenderTextOnOverlay(G)},S=function(a,f,d){for(var e=f.substr(a,1);" "!=e&&a>c[d].start;e=f.substr(a,1))a--;return a},V=function(a,f,d){for(var e=f.substr(a,1);" "!=e&&a<c[d].end;e=f.substr(a,1))a++;return a},T=function(a,f,d,e,b){f=u(e);d=u(e,b);d-=replaceLength[a].start;f-=replaceLength[a].start;d=c[a].length-d;f=c[a].length-f;f=replaceLength[a].end-f-1;d=replaceLength[a].end-d-1;W(f,d,a);
return{selectionStart:f,selectionEnd:d}},F=function(a,f,d,e){var b=f.substring(0,d);f=f.substring(e);a.data.obj.value=b+f;a=a.data.obj;a.setSelectionRange?(a.focus(),a.setSelectionRange(d,d)):a.createTextRange&&(a=a.createTextRange(),a.collapse(!0),a.moveEnd("character",d),a.moveStart("character",d),a.select())};return{init:function(a,f){if(mooConfig.isMention){I=f;switch(f){case "edit_activity":H=l("#"+a).val(),Q(H,l("#"+a))}-1==l.inArray(a,A)&&(0==Object.keys(z).length?P?A.push(a):(P=!0,A.push(a),
(new Bloodhound({datumTokenizer:function(d){return Bloodhound.tokenizers.whitespace(d.name)},queryTokenizer:Bloodhound.tokenizers.whitespace,prefetch:{url:mooConfig.url.base+"/users/friends.json",cache:!1,filter:function(d){l.each(d.data,function(e,b){z[b.id]=b.name;C[b.id]=b.name;O[b.id]=b.avatar});for(i=0;i<A.length;i++)K(z,A[i]);A=[];return l.map(d.data,function(e){return e})}},identify:function(d){return d.id}})).initialize()):K(z,a))}},resetMention:function(a){a.siblings("input.messageHidden").val("");
a.siblings("div.textoverlay").html("");E(a)},reConfigOverlay:v,addMention:function(a,f,d){z[a]=f;K(z,d)}}});