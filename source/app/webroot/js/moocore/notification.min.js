(function(a,e){"function"===typeof define&&define.amd?define("jquery mooAjax mooAlert mooButton mooPhrase mooBehavior mooUser tinycon slimScroll spinner".split(" "),e):"object"===typeof exports?module.exports=e(require("jquery")):a.mooNotification=e()})(this,function(a,e,u,p,q,v,f){var h={},r=!0,t=1E4,w=function(){a("#notificationDropdown")&&(a("#notificationDropdown").unbind("click"),a("#notificationDropdown").click(function(){var b=h.show_notification;if("undefined"!=typeof b){var c=a(this).find(".spin");
c.spin({lines:10,length:5,width:4,radius:8});e.get({url:b},function(d){c.spin(!1);a("#notifications_list").html(d);a(".initSlimScroll").slimScroll({height:"500px"})})}}));a("#conversationDropdown")&&(a("#conversationDropdown").unbind("click"),a("#conversationDropdown").click(function(){var b=h.show_conversation,c=a(this).find(".spin");c.spin({lines:10,length:5,width:4,radius:8});e.get({url:b},function(d){c.spin(!1);a("#conversation_list").html(d);a(".initSlimScroll").slimScroll({height:"500px"})})}))},
x=function(){var b=h.refresh_notification_url;"undefined"!=typeof b&&window.setInterval(function(){a.getJSON(b,function(c){a("#notification_count")&&a("#notification_count").html(c.notification_count);0<parseInt(c.notification_count)?0<a(".notification_count").length?a(".notification_count").html(c.notification_count):a("#notificationDropdown").append('<span class="notification_count">1</span>'):a(".notification_count")&&(a(".notification_count").remove(),a(document).find(".notification_item").each(function(){0<
a(this).find(".unread").length&&k(a(this))}));0<parseInt(c.conversation_count)?0<a(".conversation_count").length?a(".conversation_count").html(c.conversation_count):a("#conversationDropdown").append('<span class="conversation_count">1</span>'):a(".conversation_count")&&a(".conversation_count").remove()}).fail(function(){console.log("Error when calling "+b)})},t)},l=function(b){f.validateUser()&&e.get({url:mooConfig.url.base+"/notifications/ajax_remove/"+b},function(c){a(a(".notification_item[rel='"+
b+"']")[0]).find(".notification_item_status").hasClass("unread")&&"0"!=a("#notification_count").html()&&(c=parseInt(a(".notification_count").html())-1,0==c?a(".notification_count").remove():a(".notification_count").html(c),a("#notification_count").html(c));a(".notification_item[rel='"+b+"']").slideUp("slow",function(){a(".notification_item[rel='"+b+"']").remove()});a("body").trigger("afterRemoveNotificationCallback",[])})},k=function(b){b.find(".unread").removeClass("unread");b.find(".mark_read").hide();
b.find(".mark_unread").show()};return{init:function(){r&&(w(),x())},setUrl:function(b){h=b},setActive:function(b){r=b},setInterval:function(b){0<b&&(t=1E3*b)},removeNotification:l,initAjaxShow:function(){a(".removeNotification").unbind("click");a(".removeNotification").click(function(){var b=a(this).data();l(b.id)});a(".clearAllNotification").unbind("click");a(".clearAllNotification").click(function(){f.validateUser()&&(a.get(mooConfig.url.base+"/notifications/ajax_clear"),a(".notification_list").slideUp(),
a("#new_notifications").fadeOut(),a("#notification_count").html("0"),a(".notification_count").html("0"),Tinycon.setBubble(0),a("body").trigger("afterClearNotificationCallback",[]))});v.initMoreResults()},initNotification:function(){a("#notificationButton").unbind("click");a("#notificationButton").click(function(){var b=a("#item_type").val(),c=a("#item_id").val();p.disableButton("notificationButton");a("#notificationButton").spin("small");a.post(mooConfig.url.base+"/notifications/ajax_save",a("#notificationForm").serialize(),
function(d){p.enableButton("notificationButton");a("#notificationButton").spin(!1);d=a.parseJSON(d);1==d.result?(a(".error-message").hide(),1==d.is_stop?a("#stop_notification_"+b+c).html(q.__("turn_on_notifications")):a("#stop_notification_"+b+c).html(q.__("stop_notifications")),u.alert(d.message),a("#portlet-config").modal("hide"),a("#themeModal").modal("hide")):(a(".error-message").show(),a(".error-message").html(d.message))})});return!1},initRemoveNotification:function(){a(".removeNotification").unbind("click");
a(".removeNotification").on("click",function(){var b=a(this).data();l(b.id)})},initMarkRead:function(){a(".markMsgStatus").unbind("click");a(".markMsgStatus").click(function(){if(f.validateUser()){var b=a(this).data(),c=a(this);e.post({url:mooConfig.url.base+"/notifications/mark_read",data:{id:b.id,status:b.status}},function(d){c.data("status","1"===b.status?"0":"1");var m=a.parseJSON(d),g=a("#notification_count").html();a(".notification_item[rel='"+b.id+"']").each(function(){if("1"===m.status)k(a(this)),
a("#notification_count").html(parseInt(g)-1),0<parseInt(g)-1?0<a(".notification_count").length?a(".notification_count").html(parseInt(g)-1):a("#notificationDropdown").append('<span class="notification_count">1</span>'):a(".notification_count")&&a(".notification_count").remove();else{var n=a(this);n.find(".notification-group-main").addClass("unread");n.find(".mark_read").hide();n.find(".mark_unread").show();a("#notification_count").html(parseInt(g)+1);0<a(".notification_count").length?a(".notification_count").html(parseInt(g)+
1):a("#notificationDropdown").append('<span class="notification_count">1</span>')}})})}});a(".markAllNotificationAsRead").unbind("click");a(".markAllNotificationAsRead").click(function(){f.validateUser()&&e.post({url:mooConfig.url.base+"/notifications/mark_all_read",data:{}},function(b){1==a.parseJSON(b).success&&(a(".mark_read").hide(),a(".mark_unread").show(),a(".notification_count").remove(),a("#notification_count").html("0"),a(document).find(".notification_item").each(function(){0<a(this).find(".unread").length&&
k(a(this))}))})});a(".clearAllNotifications").unbind("click");a(".clearAllNotifications").click(function(){f.validateUser()&&e.post({url:mooConfig.url.base+"/notifications/clear_all_notifications",data:{}},function(b){a(".notification_count").remove();a("#notification_count").html("0");a("#notifications_list").html(b);a("#notificationDropdown").next("ul:first").spin(!1);a(".initSlimScroll").slimScroll({height:"500px"})})})},friendAdd:function(){a(".reponse_request").unbind("click");a(".reponse_request").click(function(){if(f.validateUser()&&
!a(this).hasClass("reponse_request_disable")){a(this).parent().find(".reponse_request").addClass("reponse_request_disable");var b=a(this).data("id"),c=a(this).data("status");a(this);var d=0;0<a(".notification_count").length?d=a(".notification_count").html():0<a("#notification_count").length&&(d=a("#notification_count").html());d=parseInt(d)-1;0<a("#notification_count").length&&0<=d&&a("#notification_count").html(d);0<d?0<a(".notification_count").length?a(".notification_count").html(d):a("#notificationDropdown").append('<span class="notification_count">1</span>'):
a(".notification_count")&&a(".notification_count").remove();e.post({url:mooConfig.url.base+"/friends/ajax_friend",data:{id:b,status:c}},function(m){a(".notification_item[rel='"+b+"']").each(function(){a(this).html(m)})})}})}}});